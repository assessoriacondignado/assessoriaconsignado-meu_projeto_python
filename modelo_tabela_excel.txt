REGRAS PARA SEREM APLICADAS NA FUNﾃﾃグ, PARA MATER AS BOAS PRﾃゝICAS NO USO DA TABELA (Data Editor) DENTRO DO SISTEMA


import streamlit as st
import pandas as pd
import io

def app_planilha_avancada():
    st.markdown("### 投 Gestﾃ｣o de Planilha (Excel-Like)")

    # 1. VISUALIZAR / CARREGAR DADOS INICIAIS
    # No seu caso, viria do banco de dados (ex: listar_tabelas_schema ou sua query SQL)
    if 'df_dados' not in st.session_state:
        # Exemplo de estrutura inicial vazia
        st.session_state['df_dados'] = pd.DataFrame(columns=[
            "Nome Cliente", "CPF", "Data Nasc.", "Valor Contrato", "Status"
        ])

    df_editavel = st.session_state['df_dados'].copy()

    # 2. FUNﾃﾃグ EDITAR & COPIAR/COLAR (st.data_editor)
    # num_rows="dynamic" -> Permite adicionar linhas colando do Excel
    # column_config -> GARANTE A FORMATAﾃﾃグ CORRETA
    
    st.info("庁 Dica: Copie as cﾃｩlulas do seu Excel e tecle **Ctrl+V** clicando na primeira cﾃｩlula vazia abaixo.")
    
    df_resultado = st.data_editor(
        df_editavel,
        key="editor_principal",
        num_rows="dynamic",  # PERMITE COLAR LINHAS DO EXCEL E ELAS Sﾃグ CRIADAS AUTOMATICAMENTE
        use_container_width=True,
        height=500,
        column_config={
            "Nome Cliente": st.column_config.TextColumn(
                "Nome Completo",
                max_chars=100,
                validate=r"^.+$" # Exige que nﾃ｣o seja vazio
            ),
            "CPF": st.column_config.TextColumn(
                "CPF",
                help="Digite apenas nﾃｺmeros ou com pontuaﾃｧﾃ｣o",
                width="medium"
            ),
            "Data Nasc.": st.column_config.DateColumn(
                "Nascimento",
                format="DD/MM/YYYY", # Forﾃｧa formato visual brasileiro
                step=1
            ),
            "Valor Contrato": st.column_config.NumberColumn(
                "Valor (R$)",
                format="R$ %.2f", # Exibe como moeda, mas salva como nﾃｺmero puro
                min_value=0,
                step=0.01
            ),
            "Status": st.column_config.SelectboxColumn(
                "Situaﾃｧﾃ｣o",
                options=["Ativo", "Pendente", "Cancelado"],
                default="Pendente" # Valor padrﾃ｣o se colar vazio
            )
        }
    )

    # 3. VALIDAﾃﾃグ E LIMPEZA (EVITAR ERRO DE FORMATAﾃﾃグ)
    if st.button("沈 Salvar Alteraﾃｧﾃｵes"):
        if not df_resultado.empty:
            # Remove linhas totalmente vazias que podem ter ficado
            df_limpo = df_resultado.dropna(how='all')

            # --- TRATAMENTO DE DADOS (CRﾃ控ICO) ---
            # Forﾃｧa conversﾃ｣o para evitar erro de string em campo numﾃｩrico
            try:
                # Exemplo: Limpar R$ e converter para float se o copy/paste vier sujo
                # (O data_editor jﾃ｡ filtra muito, mas isso ﾃｩ seguranﾃｧa extra)
                if df_limpo['Valor Contrato'].dtype == 'object':
                    df_limpo['Valor Contrato'] = df_limpo['Valor Contrato'].astype(str).str.replace('R$', '').str.replace('.', '').str.replace(',', '.').astype(float)
                
                # Salva no estado ou Banco de Dados
                st.session_state['df_dados'] = df_limpo
                st.success(f"{len(df_limpo)} registros processados com sucesso!")
                st.dataframe(df_limpo.head()) # Mostra prﾃｩvia
            
            except Exception as e:
                st.error(f"Erro de formataﾃｧﾃ｣o nos dados colados: {e}")
        else:
            st.warning("A planilha estﾃ｡ vazia.")

    # 4. EXPORTAR EM CSV
    if not st.session_state['df_dados'].empty:
        st.divider()
        csv = st.session_state['df_dados'].to_csv(index=False).encode('utf-8')
        
        st.download_button(
            label="踏 Baixar Planilha (CSV)",
            data=csv,
            file_name=f"exportacao_planilha_{pd.Timestamp.now().strftime('%Y%m%d')}.csv",
            mime="text/csv",
            type="primary"
        )

if __name__ == "__main__":
    app_planilha_avancada()